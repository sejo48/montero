<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitsubishi Montero Sport 1999</title>
    <style>
        /* Estilos generales del cuerpo de la página */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            color: #343a40;
        }

        .main-container { /* Contenedor para centrar el contenido */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Contenedor principal del vehículo */
        .vehiculo {
            background-color: #ffffff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            border: 1px solid #dee2e6;
            position: relative;
        }

        /* Imagen de portada */
        .cover-image-container {
            width: 100%;
            max-height: 300px;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 8px;
        }

        /* Encabezados */
        h2, h3 {
            color: #0056b3;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        h2 { font-size: 1.8em; margin-top: 0; }
        h3 { font-size: 1.4em; }

        /* Listas */
        ul { list-style-type: none; padding-left: 0; }
        ul li { padding: 8px 0; border-bottom: 1px solid #f1f1f1; }
        ul li:last-child { border-bottom: none; }
        li strong { color: #495057; min-width: 180px; display: inline-block; }
        
        ul ul {
            padding-left: 20px; 
            margin-top: 5px;
        }
        ul ul li {
            border-bottom: none; 
            padding: 4px 0; 
            font-size: 0.95em;
        }
        ul ul li::before { 
            content: "– "; 
            color: #007bff;
            margin-right: 5px;
        }


        /* Contenedor para botones de acción de fotos/manual */
        .actions-container {
            display: flex;
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 15px; 
        }

        /* Botones generales y específicos */
        .actions-container button, button#btn-delete-selected, button[onclick="guardarNotasGenerales()"] {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.90em; 
            transition: background-color 0.3s ease, transform 0.1s ease;
            flex-grow: 1; 
            min-width: 120px; 
        }
        .actions-container button:hover, button#btn-delete-selected:hover, button[onclick="guardarNotasGenerales()"]:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .actions-container button:active, button#btn-delete-selected:active, button[onclick="guardarNotasGenerales()"]:active {
            transform: translateY(0px);
        }

        #btn-config-fotos { background-color: #6c757d; }
        #btn-config-fotos:hover { background-color: #5a6268; }
        #btn-ver-manual { background-color: #17a2b8; } 
        #btn-ver-manual:hover { background-color: #138496; }


        textarea#notas-montero {
            width: calc(100% - 22px); padding: 10px; margin-top: 15px;
            border-radius: 6px; border: 1px solid #ced4da; min-height: 100px;
            font-family: inherit; font-size: 0.95em; box-sizing: border-box;
        }

        /* Contenedor de la galería principal de fotos */
        #fotos-montero-display {
            margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;
        }
        .photo-display-item {
            width: calc(25% - 10px); 
            border-radius: 4px; 
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            padding: 5px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column; 
            align-items: center; 
        }
        .photo-display-item img {
            width: 100%; 
            height: 100px; 
            object-fit: cover; 
            display: block;
            border-radius: 3px; 
            cursor: pointer; 
            margin-bottom: 5px; 
        }
        .photo-display-item-details { 
            font-size: 0.75em;
            color: #333;
            text-align: center;
            width: 100%;
            padding: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; 
            cursor: default; 
        }


        input[type="file"] { display: none; }

        /* --- Estilos para Modales --- */
        .modal {
            display: none; /* Asegurar que esté oculto por defecto */
            position: fixed; 
            z-index: 1000;
            left: 0; top: 0; 
            width: 100%; height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            padding: 20px; /* Espacio para que el contenido no toque los bordes */
            box-sizing: border-box;
            align-items: center; /* Para centrar verticalmente el contenido del modal */
            justify-content: center; /* Para centrar horizontalmente el contenido del modal */
        }
        
        /* Contenido del modal de configuración */
        #config-fotos-modal .modal-content {
            background-color: #fefefe; 
            margin: auto; /* Necesario si el modal padre no es flex */
            padding: 20px;
            border: 1px solid #888; 
            width: 85%; 
            max-width: 750px; 
            border-radius: 8px; 
            position: relative; /* Para el botón de cierre absoluto */
            box-sizing: border-box;
        }
        
        /* Contenido del modal de imagen fullscreen */
        #fullscreen-image-modal .fullscreen-modal-content { 
            background-color: transparent; 
            padding:0;
            width: auto; /* Ajustar al contenido */
            max-width: 90vw; /* Máximo ancho viewport para la imagen y detalles */
            height: auto; /* Ajustar al contenido */
            max-height: 90vh; /* Máximo alto viewport para la imagen y detalles */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            border: none; 
            box-shadow: none; 
            position: relative; /* Para el botón de cierre */
        }

        #fullscreen-image { /* La imagen en pantalla completa */
            max-width: 100%; /* Ocupa el ancho disponible en .fullscreen-modal-content */
            max-height: calc(90vh - 60px); /* Deja espacio para detalles y padding del modal */
            object-fit: contain; /* Muestra la imagen completa sin recortes */
            display: block; 
            border-radius: 4px;
            box-shadow: 0 0 25px rgba(0,0,0,0.7); 
            margin-bottom: 10px; 
        }
        #fullscreen-details { /* Los detalles de la imagen en pantalla completa */
            color: #fff; 
            text-align: center; 
            padding: 8px 12px; 
            background-color: rgba(0,0,0,0.6); 
            border-radius: 4px;
            max-width: 80%; /* Ancho máximo para los detalles */
            font-size: 0.9em;
            overflow-y: auto; 
            max-height: 10vh; /* Altura máxima para los detalles, ajustado */
            word-wrap: break-word; /* Para que el texto largo se ajuste */
        }
        
        /* Botón de cierre para todos los modales */
        .modal-close-btn {
            position: absolute; /* Posicionado relativo al .modal-content o .fullscreen-modal-content */
            top: 10px;
            right: 15px;
            color: #aaa; 
            font-size: 30px; 
            font-weight: bold;
            cursor: pointer;
            z-index: 1002; /* Asegurar que esté sobre otros elementos del modal */
        }
        #fullscreen-image-modal .modal-close-btn { /* Estilo específico si es necesario para el de fullscreen */
             color: #f1f1f1;
        }
        .modal-close-btn:hover, .modal-close-btn:focus {
            color: black; 
            text-decoration: none;
        }
         #fullscreen-image-modal .modal-close-btn:hover {
            color: #bbb;
         }


        /* Modal de Configuración de Fotos (Galería interna y controles) */
        #config-fotos-gallery {
            display: flex; flex-wrap: wrap; gap: 15px; 
            max-height: 350px; 
            overflow-y: auto; padding: 10px;
            border: 1px solid #eee; margin-bottom:15px;
        }
        .config-photo-item {
            width: calc(33.333% - 10px); 
            border: 1px solid #ccc; padding: 8px; border-radius: 4px;
            text-align: center; display: flex; flex-direction: column; gap: 5px;
        }
        .config-photo-item img {
            max-width: 100%; height: 70px; object-fit: contain; margin-bottom: 5px;
        }
        .config-photo-item textarea { 
            width: calc(100% - 10px); 
            min-height: 40px;
            font-size: 0.85em;
            padding: 5px;
            border: 1px solid #d0d0d0;
            border-radius: 3px;
            box-sizing: border-box;
            resize: vertical; 
        }
        .config-photo-item .checkbox-container { 
             display: flex; align-items: center; justify-content: center; margin-top: 5px;
        }
        .config-photo-item input[type="checkbox"] { margin-right: 5px; }

        #pin-input-container { margin-top: 15px; }
        #pin-input {
            padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        #btn-delete-selected { background-color: #dc3545; }
        #btn-delete-selected:hover { background-color: #c82333; }


        /* Media Query */
        @media (max-width: 700px) {
            .vehiculo { width: 95%; padding: 20px 15px; }
            .cover-image-container { max-height: 200px; }
            h2 { font-size: 1.6em; } h3 { font-size: 1.3em; }
            li strong { min-width: auto; display: block; margin-bottom: 3px; font-weight: bold; }
            
            .photo-display-item { width: calc(33.333% - 8px); } 
            .photo-display-item img { height: 80px; }
            .photo-display-item-details { font-size: 0.7em; }

            .config-photo-item { width: calc(50% - 10px); } 
            .config-photo-item img { height: 60px; }

            #config-fotos-modal .modal-content { width: 95%; } 
            #fullscreen-image-modal .fullscreen-modal-content { max-width: 95vw; max-height: 95vh; } 
            #fullscreen-image { max-height: calc(95vh - 70px); } /* Ajuste para móviles */
            #fullscreen-details { font-size: 0.8em; max-width: 90%; max-height: 15vh;}
        }
         @media (max-width: 480px) {
            .photo-display-item { width: calc(50% - 5px); } 
            .photo-display-item img { height: 70px; }
            .config-photo-item { width: 100%; } 
            .actions-container button { min-width: calc(50% - 4px); } 
            #fullscreen-image { max-height: calc(95vh - 80px); } /* Más espacio para detalles en pantallas muy pequeñas */
            #fullscreen-details { font-size: 0.75em; max-height: 20vh;}
         }
    </style>
</head>
<body>

<div class="main-container">
    <div class="vehiculo" id="montero">
        <div class="cover-image-container">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiyeJiADyhmrZ1SgyH6-clYmHFxgMwvg7NfQMhNyS93v7kWiIgWe-ew8EFpaDwRoIKHNmi973QmoGW5DCuUCyc-7AeG99yIHoFH2DOwyOcLXFZtgX0eUZkwg3AuN9HN3iqLddvQlf4ncHbSKpjGADYHWf-IzeIK8zrQ2DgCDuexxmBAiuRFv9HHmxXvH3k/s320/20240821_162930.jpg" alt="Portada del Mitsubishi Montero Sport" class="cover-image"
                 onerror="this.style.display='none'; console.warn('No se pudo cargar la imagen de portada.');">
        </div>

        <h2>Mitsubishi Montero Sport 1999</h2>
        <ul>
            <li><strong>Motor:</strong> 6G72 V6 (2.972 cc)</li>
            <li><strong>Potencia:</strong> hasta 177 hp (132 kW) @ 5000-5500 RPM (SOHC 12V)</li>
            <li><strong>Torque:</strong> hasta 255 Nm (188 lb-ft) @ 4000-4500 RPM</li>
            <li><strong>Transmisión:</strong> Automática R4AW3 (4 velocidades)</li>
            <li><strong>Neumáticos:</strong> 265/70 R15 110S (Presión recomendada: 26-29 PSI del./tras.)</li>
            <li><strong>VIN:</strong> JA4LS31P4WP018774</li>
            <li><strong>Peso bruto vehicular (GVWR):</strong> 5.005 lbs (2.268 kg)</li>
            <li><strong>Peso en vacío (Curb Weight):</strong> Aprox. 3.900-4.200 lbs (1.770-1.900 kg)</li>
            <li><strong>Color ext/int:</strong> 4636 / P85S74</li>
        </ul>

        <h3>🔧 Detalles del Motor 6G72 (SOHC 12V)</h3>
        <ul>
            <li><strong>Configuración:</strong> V6 a 60°</li>
            <li><strong>Cilindrada exacta:</strong> 2.972 cc (181.4 cu in)</li>
            <li><strong>Diámetro x Carrera:</strong> 91.1 mm x 76.0 mm (3.59 in x 2.99 in)</li>
            <li><strong>Relación de compresión:</strong> 8.9:1 (puede variar ligeramente según mercado)</li>
            <li><strong>Material del bloque:</strong> Hierro fundido</li>
            <li><strong>Cabezas de cilindro:</strong> Aluminio</li>
            <li><strong>Árbol de levas:</strong> SOHC (Un solo árbol de levas en cabeza por bancada)</li>
            <li><strong>Válvulas por cilindro:</strong> 2 (Total 12 válvulas)</li>
            <li><strong>Sistema de combustible:</strong> Inyección multipunto (MPI) Mitsubishi ECI-Multi</li>
            <li><strong>Orden de encendido:</strong> 1-2-3-4-5-6</li>
            <li><strong>Ralentí (RPM):</strong> 700 ± 100 RPM</li>
            <li><strong>Tipo de bujía (ejemplo):</strong> NGK BKR5ES-11 o equivalente</li>
            <li><strong>Luz de bujía:</strong> 1.0-1.1 mm (0.039-0.043 in)</li>
        </ul>

        <h3>⚙️ Más Especificaciones Técnicas</h3>
        <ul>
            <li><strong>Capacidad de aceite del motor (con filtro):</strong> 4.9 L (5.2 US qt)</li>
            <li><strong>Tipo de aceite recomendado:</strong> SAE 5W-30, 5W-40, 10W-30 (consultar manual para clima específico)</li>
            <li><strong>Capacidad del sistema de refrigeración:</strong> Aprox. 9.0 - 9.5 L (9.5 - 10.0 US qt)</li>
            <li><strong>Tipo de refrigerante:</strong> Anticongelante a base de etilenglicol de alta calidad</li>
            <li><strong>Capacidad del tanque de combustible:</strong> 74 L (19.5 US gal)</li>
            <li><strong>Transmisión Automática (R4AW3/V4AW3):</strong>
                <ul>
                    <li><strong>Capacidad de fluido (total):</strong> Aprox. 7.2 - 8.2 L (7.6 - 8.7 US qt)</li>
                    <li><strong>Tipo de fluido:</strong> Mitsubishi Diamond ATF SP-II, SP-III o equivalente</li>
                </ul>
            </li>
            <li><strong>Caja de transferencia (si aplica 4WD):</strong>
                <ul>
                    <li><strong>Capacidad de fluido:</strong> Aprox. 2.5 L (2.6 US qt)</li>
                    <li><strong>Tipo de fluido:</strong> Aceite para engranajes API GL-4 SAE 75W-90 o 80W-90</li>
                </ul>
            </li>
            <li><strong>Diferencial Delantero (si aplica 4WD):</strong>
                <ul>
                    <li><strong>Capacidad de fluido:</strong> Aprox. 1.2 L (1.3 US qt)</li>
                    <li><strong>Tipo de fluido:</strong> Aceite hipoide para engranajes API GL-5 SAE 80W-90</li>
                </ul>
            </li>
             <li><strong>Diferencial Trasero:</strong>
                <ul>
                    <li><strong>Capacidad de fluido:</strong> Aprox. 2.6 L (2.7 US qt)</li>
                    <li><strong>Tipo de fluido:</strong> Aceite hipoide para engranajes API GL-5 SAE 80W-90 (SAE 90 si es LSD)</li>
                </ul>
            </li>
            <li><strong>Sistema de Frenos:</strong>
                <ul>
                    <li><strong>Delanteros:</strong> Discos ventilados</li>
                    <li><strong>Traseros:</strong> Tambores (algunos modelos podrían tener discos)</li>
                    <li><strong>Fluido de frenos:</strong> DOT 3 o DOT 4</li>
                </ul>
            </li>
            <li><strong>Dirección:</strong> Asistida, de piñón y cremallera</li>
            <li><strong>Dimensiones (aproximadas):</strong>
                <ul>
                    <li><strong>Largo:</strong> 4530 - 4620 mm (178.3 - 181.9 in)</li>
                    <li><strong>Ancho:</strong> 1695 - 1775 mm (66.7 - 69.9 in)</li>
                    <li><strong>Alto:</strong> 1700 - 1730 mm (66.9 - 68.1 in)</li>
                    <li><strong>Distancia entre ejes:</strong> 2725 mm (107.3 in)</li>
                </ul>
            </li>
        </ul>

        <h3>⚠️ Problemas comunes</h3>
        <ul>
            <li>Consumo de aceite elevado tras 200.000 km (especialmente retenes de válvula)</li>
            <li>Fugas en sistema de refrigeración (radiador, mangueras, bomba de agua)</li>
            <li>Fallas eléctricas (sensores como MAF, TPS; bobinas, cables de encendido)</li>
            <li>Difícil acceso a bujías traseras (requiere desmontar plenum de admisión)</li>
            <li>Corrosión en chasis y líneas de freno en climas húmedos o con sal en carreteras.</li>
        </ul>

        <h3>🛠️ Recomendaciones de mantenimiento</h3>
        <ul>
            <li>Usar aceite SAE 5W-30 o 5W-40 sintético o semi-sintético de buena calidad.</li>
            <li>Cambio de aceite y filtro: cada 5.000-7.500 km (uso severo) o 10.000-15.000 km (uso normal/manual).</li>
            <li>Revisar y reemplazar refrigerante cada 2-3 años o 50.000 km.</li>
            <li>Inspeccionar correas (distribución, accesorios) según intervalo del fabricante (correa de distribución es crítica, aprox. 90.000-100.000 km).</li>
            <li>Inspeccionar cableado y sensores del motor regularmente.</li>
            <li>Cambiar bujías (platino/iridio recomendadas) cada 80.000-100.000 km.</li>
            <li>Revisar y cambiar fluidos de transmisión, diferenciales y caja de transferencia según manual.</li>
            <li>Inspeccionar frenos y suspensión anualmente o cada 20.000 km.</li>
        </ul>

        <h3>📝 Información del Manual de Servicio</h3>
        <ul>
            <li><strong>Uso del Manual:</strong>
                <ul>
                    <li>Define valores estándar y límites para inspección y ajuste.</li>
                    <li>Incluye diagramas de componentes y secuencias de mantenimiento.</li>
                    <li>Utiliza símbolos para lubricación, selladores y puntos esenciales.</li>
                </ul>
            </li>
            <li><strong>Indicaciones de Modelo (Abreviaturas Comunes):</strong>
                <ul>
                    <li><strong>M/T:</strong> Transmisión Manual.</li>
                    <li><strong>SOHC:</strong> Motor con un solo árbol de levas en cabeza.</li>
                    <li><strong>MPI:</strong> Inyección Multipunto.</li>
                    <li><strong>DIESEL:</strong> Motor Diesel.</li>
                    <li><strong>4WD:</strong> Tracción en las Cuatro Ruedas.</li>
                </ul>
            </li>
            <li><strong>Precauciones Generales Antes del Servicio:</strong>
                <ul>
                    <li>Consultar el manual para especificaciones de torque.</li>
                    <li>Seguir los procedimientos para el sistema SRS (Airbag) si se va a trabajar cerca de sus componentes.</li>
                    <li>Utilizar los puntos de apoyo correctos para levantar el vehículo.</li>
                </ul>
            </li>
            <li><strong>Diagnóstico y Solución de Problemas:</strong>
                <ul>
                    <li>Los manuales suelen incluir un flujo estándar de diagnóstico.</li>
                    <li>Se pueden leer códigos de diagnóstico mediante herramientas (MUT-II) o patrones de luces de advertencia.</li>
                    <li>Contienen tablas de referencia de datos de servicio y valores de terminales de ECU.</li>
                </ul>
            </li>
        </ul>
        
        <hr style="margin-top: 20px; margin-bottom: 20px;">
        <h3>Gestión de Fotos y Notas</h3>
        <div class="actions-container">
            <button onclick="abrirCamara()">Tomar Foto / Galería</button>
            <button id="btn-config-fotos" onclick="abrirModalConfiguracionFotos()">Configurar Fotos</button>
            <button id="btn-ver-manual" onclick="abrirManual()">Ver Manual (Visor)</button>
        </div>
        <input type="file" accept="image/*" onchange="procesarFotoCargada(event)" id="file-montero" />
        
        <div id="fotos-montero-display">
            </div>

        <textarea id="notas-montero" placeholder="Notas de mantenimiento generales..."></textarea>
        <button onclick="guardarNotasGenerales()">Guardar Notas Generales</button>
    </div>
</div>

<div id="config-fotos-modal" class="modal">
    <div class="modal-content"> <span class="modal-close-btn" onclick="cerrarModalConfiguracionFotos()">&times;</span>
        <h4>Configuración de Fotos</h4>
        <p>Selecciona las fotos que deseas eliminar e ingresa o edita sus detalles. Luego, ingresa el PIN para eliminar.</p>
        <div id="config-fotos-gallery">
            </div>
        <div id="pin-input-container">
            <label for="pin-input">PIN para eliminar:</label>
            <input type="password" id="pin-input" maxlength="4" autocomplete="off">
            <button id="btn-delete-selected" onclick="solicitarBorradoFotos()">Eliminar Seleccionadas</button>
        </div>
    </div>
</div>

<div id="fullscreen-image-modal" class="modal" onclick="cerrarImagenFullscreen(event)">
    <span class="modal-close-btn" onclick="cerrarImagenFullscreen(null, true)">&times;</span>
    <div class="fullscreen-modal-content">
        <img id="fullscreen-image">
        <div id="fullscreen-details"></div> 
    </div>
</div>


<script>
    let fotosCargadas = []; 
    const PDF_VIEWER_URL = 'web/viewer.html?file=../pdfs/manual.pdf'; 

    const manualImageUrls = [
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhkUzawOyPBXI0xRY303y5CtLEOtWojdnK4wzhlCjPr_DTuvLg_ai4G1UihyphenhyphenmUpbz3VIMAcXyu4vcOeCqd2xVX6g05BnbbXwEGSpnEO3BORm0XRZ0n2VqVysSPWyf6zAg9LNrFhuJ06Jygg6xULf-kTDsqE55XPRsAbGCGqBxzjC3-isTVBGM9Iug2rvJc/s320/7f0925c9cf6f4093678c62616dc12746-1.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTi_AavsMDfYf4v0NZsIElDxON7ferxVXiyn6ed4F32ruewh7BV0QoL7oNWexpS1s1V4zfyTv1c82MJkLRG4YiFCLETF9AQ9T21MB6WlJS7z9TCy-6b2mLqmmENWvGEvFo1toTsRXEixYcSXA46xl5w6Rbb4V5aCIY4rZc968ciDumW5stw14h0twyhyc/s320/7f0925c9cf6f4093678c62616dc12746-2.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCihf0vU56Sxs58z84QALQB-1q10xVXhoTmCJPaFIDYZZvyz5qJ12Z0SJugf9ehXaOcXzGCbOPMNUGLlmfOqow_chiHlKgBh_SebophyphenhyphenNlCF1eBowMpqe4iOzMbLzfmukLsrDhjXEjYiuFVDkCWmIYGhk-xF6AwP9UOvcIgql3CRVtSKEzh7RGPBq8lD8/s320/7f0925c9cf6f4093678c62616dc12746-3.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgj7YBtNOwfZaNn1QLNJBT604kbCm_BeR7UuBlE2qitSqc-9urydSlbXI2yQfRyjNfYN9Ug4QQut6jv-RL4no7Afcv_O2IWsP5Fn_xK9uCjjq0MWUCn1k6diLcLAQpqFizcBlgTt5io6VXV2jsfdd8eeQlq_7deWur8tBf6FFOd78Zb-gVkNYQWsjnZn5w/s320/7f0925c9cf6f4093678c62616dc12746-4.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiitGLNjy-BlHLbounpraOQQQTBOjfqPioSD87qlbr2T4zcZOhZPQxetV7XVd6CIFqsDoGO0-_uDR5p7VCsLx1mLubTtHJb68QElyctaE8n4YxBe-dGpnNVaEKCruS5FI7ow-W3M7XC_BChwXXKPyfXgd0hG7712nWEPBIgNFXQhKH4qKNwIrkocP0OB_Y/s320/7f0925c9cf6f4093678c62616dc12746-5.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJXq_g7wPSvOazoqja2U_EeSaSaBJ0pqIE2F85zjyGrZ1qmNb4Nr2b_ei7uGc3tXssnWAoQch6WInLWHg-YvR_sJbx8bilLJKLcoOk7r-cFFD31avMA-n7kU23ky0KNzI3H0iGpxoBIFewWfvecb4LTy2ojsFgcOVWKn1W7du83zjJe3M0Gm7aJSqRDww/s320/7f0925c9cf6f4093678c62616dc12746-6.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhtNDIxoIA4bagqn5aNn__jOPaKRudIK2CEKgP9ESGg9h2zvQu6946-urfmUkQcpWYB9NgIQmrfgpTcjpNIVdXFUWfIJXMpVBaNyMfjFAuaVnHIIqXJaOTWKXyI7l2-LRDvhvfXi-KraQigg5ZUgQuaRK0-0knjyKQuQyBKgdQupYWsZM6Fn3KWZaPGbCU/s320/7f0925c9cf6f4093678c62616dc12746-7.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_LmKJASf6XKCENNKql5IZV6ELEdoiBEqpDOSDgx9ujEgMZTXL7q8mM494Wxy4nVoLgW3fcqqIY7PyTL3seOunNilDls1FeUCU6fBmezJSZ0psJL9F1lljbzSGzQ12s9cM2cw2Mb1ZJNXe41Hb_GE08C4isRlRYQGkhmcSVMOcjas1OimC-wR6xUJL22Y/s320/7f0925c9cf6f4093678c62616dc12746-8.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPtSKJVUvsYKeFNFIjOF90NbC9KZzlqgt6XoFTpS14ntZnC8ZMZpUfnnnpleq-3PXN5IxYhIT2UDWEQG07-L4d-OZ3jKcStTOK42zQBZMkiGxR-2HJc-MpIqRWcFwpcgJoUB35rlnXRNKSlvpsh-UvJ5b0RuUIfAAkkxJvfv77CC9l8q2FZD-tDwaBtwE/s320/7f0925c9cf6f4093678c62616dc12746-9.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjLvoHryhHT-5L9GR6XuXJlZ50HZSWIBvX9fSG8PnufLoh0z0dYjmCFM-QdYxfyXutK7XzRr-ziW5FfW_ylI2Srqf5CA0KmB8fsynt53bkDHlGEcRyIkFDIIpM_kLUenDEKniMy6ChG7GydYjspfp1G9z8CsS4N9_9Yuv_2A-PTLHl35028RtpQ_kTRswQ/s320/7f0925c9cf6f4093678c62616dc12746-10.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhFWkPdet-DuuYm8AHmD_-uxqEvLDGoPOw8-nKpbNBLFtZTHuAgPFqyWsCccJ8HSnaPXFPYyfQQpkjL1Mzjm4KbyqKMyI311Z802XSKgY3qglq-vBdwH3OVnf2tOsfaNiIepMFnZQsWq1S0DQKj-0adNFg2tz-2VjK5R8wRInTUjXvh4mGJUxklQdNiE28/s320/7f0925c9cf6f4093678c62616dc12746-11.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEheXQn3QLQkBLGZG-3svrQXiIWgvBDuWxN1y0Kn24x4CuT72GIudCbXn-lXiNCPgFhU9UzjJ0Ayy6Q9KJ6SCzz0m55NvuapoI_wqSO0gvFx5IfSedr2yRJik14Ue3aywWThYSZcln73Uw_mt2x0LLKEDKnmTCB0G8DLHuHKBJ2y08kp32poAvq6AoA52hE/s320/7f0925c9cf6f4093678c62616dc12746-12.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqzJ8e_VO9O2hwgLUfElTaJ6RyN2I4uMv3_JCNtVrbGHdJaXmJ93LPApD9jmtoA8ICUOpZPMP2Y9AWJgbmKh_elTPBWVutZ7MmQuh1U5U6ZW1Q1_DxAB3xgJZoMmPJCTmOW-nhXhukHJivbbEKCSo3ReyqqNO8byTUMgfdugevMlBUhmZzMgNtReOigb8/s320/7f0925c9cf6f4093678c62616dc12746-13.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgWsQq41IpSLycityWBWr8Ef5toaTAG7lYlKRC11KDPN7z7J1ba9Qe8AUkWxQrJ5vs_TpjDCXwXVXzHRArwdXhB2Fhvqc-uT7TjV9mXYHVrJ6_tcnCfISO0V8P-c8avwDi5C4bwHWkDc2QNK3JbiA4cdWqoeTsSQZshntXA1fia6MBZGR9LCPmzhaty6Ak/s320/7f0925c9cf6f4093678c62616dc12746-14.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0woVYsEJxXoz-YmtEmxMiJbjTEkIfDUbwE4h_g__8ojtALYOp86rCQAPQSjkcvkjpZxFZ2KbFBNn27olyukB5HfOCqz8BDLYWmqLiURlVPGLhTIZdwJkir4YQknsKMGbiyroRO_tD03xVUSzuXGCL9-f2EMPGfnfgy0-npDAwTXV9Butn8piEQaRpj4I/s320/7f0925c9cf6f4093678c62616dc12746-15.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhvqDn2ZfxOvfPTIdmMH7FQ2TJdc66-JtaOJOmPPIL8rnDlUnvoBJs5MQw0WtPEQFSNSx_CEomLCKB6gKViM1CA7Faf8tXbg6RMSYAO-mYLjFCIDY1gIS8z7LLHDv9ogmHLk1QA_x915XHtcXNr8mjrNMZdcSv-5xJBk9hVSxbS_tSxHHZyWJfpBpDbzbY/s320/7f0925c9cf6f4093678c62616dc12746-16.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEienAO_U-EgkpQ-9aMkVjw35hwqvy-q69YhTuQdN31Xh8TwTe7fOQDorZlt3wKcR37GWMsYr_38CRgPDyx36hcs8gyROunYqCOADOckANeudz9-67q3HEL3nHTxkKfBDkv-STh8MX75wDWYSK9Hxg5cepwbzNAU0lP0jqBsEMBg-dUTFmejcn9tLcgea9o/s320/7f0925c9cf6f4093678c62616dc12746-17.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj_Bmbf8dSXXykLwqYEdQbaj7hKTO6BB7RWd5gNKZe8ETgbE7jwdBdXtuFQ8xUbaBgTfqw3AxIMSFNRQyciRMVbefii9xHbC8BmxxE4lfvLkL86mPOUvg5DPHmqjR5-VxQ21yGtLmWIF-kv9dreiWaBiTcmqQjGzG_eCOY9P-w-nrU_6p1lkai_Z9Ob_sM/s320/7f0925c9cf6f4093678c62616dc12746-18.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjn5lkf8A7O_vWvcAE8Ve_VQdW2cC7Lgo_IaLtM_2xuR-fGow8geLTMuGrogtbChotPyxdq3CzKqD7zZ248WG777WoqDEyK9DiriX0ysoknPp0QfXd1A05GEsAmUXRu77zg7vwELFsPFKgadJqD4jM9k8b6NXhtMeaWi6nX3KVtSC_G3oJIjEMWEC1Upt8/s320/7f0925c9cf6f4093678c62616dc12746-19.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOFlR_h0_HydwQJw1xDGel2dYLqjuqePS6gSxJJr_K8Pdq38VbYUlUhtAU4e5V_M3DbQ3ovZdtGWBuF21UINDzQZS8c4eI_dAan3hcAhn-NeJxBpK4IZMoilCiWwOelKaE3MgRLxoQ-qZ4-afWLGXzvDDHW4TCMUeHq17GJBuwblSHbF1csMjn0q7qTkI/s320/7f0925c9cf6f4093678c62616dc12746-20.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-xkPrAzVD8z3ZnIjkfkOhdMWgrc6sz-FWBIZ2zu_15fFLpwa8Es32_2Uxwz9TlsM1FM04aQmk9W6USIfu040_mXfekmHiUarcV4o7XCw_G8BrKghdOtTZrSlfzT70yiNyL0Fg5euGTiRmg9R7resviHRf2tOGdjIs5VC6PO9zTcyxIsJQwMPncpjAYPQ/s320/7f0925c9cf6f4093678c62616dc12746-21.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjFbhlQ0oeEGGWNwOFI4RYCYy24wGGFyU-KZ7vk_5u9siB65rOhmlT5skEQCdXNx69XQFuUeo_ZvwvLAXo5bGTnCPPdgIKpDF_0k5GV7kENZc-h3SVzoWZFQjn1y3Pev_D9IIgwnBmeLLlAaW3YvScPmSPunks_fVyjNbr7qzVmFISqLbQICX0a0_VduFs/s320/7f0925c9cf6f4093678c62616dc12746-22.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgrHBohD6YNKYV6RxChqKKi1a7VX6jlFxsPgiSjvtWGHeaZEyWV4EDPrpqtCxqhWzqDZNeHy6eiJmrO3uW-9KQr8jSSKOOrmlHAPDb-HIyIBhe0pMwNi5Y9ZIERzy54lZqBcTjP8DYgoHE6j3gC_h_BITVFH235jHYRS9BZfg7tOsu-NiboL2_JbjTcUMo/s320/7f0925c9cf6f4093678c62616dc12746-23.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOip9ZiohpGmKcWggBOpELpOvbhD_uGfSepH4XsRNtY-pyvuEfGuiHsTjf0PneP8qpbIjOAL2WY799_xxTZgrn-O20AWsIj6WYIg71SJLclOnc9w2MofhhpYMlHAcrX5fI1tz91TyNHQSkeM486BCYQuwykva2ZfsKN2NF1nhKkVObcEeq9Tf5G8x-JT8/s320/7f0925c9cf6f4093678c62616dc12746-24.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLrmYTzgUC1YnBpVK8bjZAJXun142z617RCKesrMa26zEzbPahSRNS8qgcgSYk3Q0XfPaxOVmInauV57l_WbAJ9oR2nURLqAIkBjnmAoYiOjzPRLlmw9CUD7wSfINPak4c2pvpxfhHuYDbhxI2I7PKfuWO6spFh4D70eKYV9P68m9ICvH-GcfF_CaFRQU/s320/7f0925c9cf6f4093678c62616dc12746-25.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7ug7dZVUOMuZ3C6ZnOTi3cx8KSaDfB2Gshra2IoTIvfcZp3N2hoYZsuqu1aFlbYBsaPRPHrjmALtpy4X2V8Q275VXU5Q2CHxi7FlYDw-ufEAVhxcxrGn9HVoIQMg1xOJ1ApntYhF9wqcS_PFO8goWjpO6YS0kAPwrmoqYJ1gNU8U4d8r4dFcpM7Fdz_A/s320/7f0925c9cf6f4093678c62616dc12746-26.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEixeMdxQ3wZpWXraY-4k719cvQmasYSPaQxyd4nxFVLjAmxD_00Y3GN9oJtVUEpD4LoV7lHkIUh4FCp02SzfDLJ5xVxqLRcxcKt2raUNZdNMjsQAIoc3RL2_7EAxLJuKovqnOXwCPDNwXT5mmbZ-Ph5IYSO0chkzYIVKBl1Wdv0Vybk7uAyYNvQUg-yOwQ/s320/7f0925c9cf6f4093678c62616dc12746-27.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi3zl43W3SyUf6XPDnyHWuWKH3ZywloGTy_8bht0fKAQDFsn-cRLbzTFjdshr3Dx8sVwqZmwE-AsnROANzN3VubBSLyz8Zby7dD_aKcNRvx4XnjLqhdrEUBBdX4VJSPPiUmMiJ6M81g6-S-y-Y1D4blUtlrHjh8SzBGSWgm9to82-GNw1TRLAo6J8B-p1o/s320/7f0925c9cf6f4093678c62616dc12746-28.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg6As43DxzbyJovKYkI99umDXOR26wMRyHGW-7bDoZuePAqn9I-P7gANVRJZMZJDpaCs1ejHWXaR6xrSZddk-raRTkmlUgBs2hO6OsMszeHaxWtp-uMZM1S7c-OKdVN6bw3S2_0b-vthfY60siFnW6ppmPDG77Or0RxQJlKy7HvV1YScknCzWIreZ3j8Fg/s320/7f0925c9cf6f4093678c62616dc12746-29.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg5a-PDfXGQXjyCShGZ9bj0yqUsc6tq8NNwKKVflfln4mK7wpQTcGK0LWl5Quv0Ws1USYp3K3EqczDg7VTQEP4whopLrdDIu9Lmv7gHmgm1FXVazQh37itOluGY3H6IeMcRA7ur0pAvWpYfO0k4mnkVeahRrX-RQqQo5I_W8UzdDhrd0Yu94WOoThRsamM/s320/7f0925c9cf6f4093678c62616dc12746-30.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEglrinQHFILDOEHHQUF0k6KtNXcidcEo_JaGUUYTnBXYBdTlJEvY5hqVJzbQwE2zIDga4TVJXkESqMRF1mfKBXHXgSKN2N0sKe3U3biK4ng7EH3gmfdr2-aI7aCMHnxLLgZXqdLdmL3GCBsjxVRIYtD1uoC4mX0J7SG2GpbesE1gagL20OA8hAysRZiJ0E/s320/7f0925c9cf6f4093678c62616dc12746-31.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgzocbkIyT_DDhBD5DOZQD1Bmxr2Oy1JtWGSJNTXrmQ8sYz6qlZ0rsDKTbDw-WO1PZ7mKK-2pDNv2sLyLRrKFPIT-MMqf7KkT9LpRAHDicCkY5aY2m9gEzY9ZvEgU0-_zybUpAoXXJxbe-80biQFisaoeWBgacMMGpoE0kQszTCJ9c_AI6gDKQjSsbrFMk/s320/7f0925c9cf6f4093678c62616dc12746-32.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhoSGvBKfvjOo3yXLaxfhOyRTnDukyhsS-uQ-EhCldbhJyxRddzORRi5Q4gFXde69tYjGUmRqocpbT-qCMl0xcxmdg2YCodiDit28qPGSDCTpw0eBybfykW4yFbxF17UCZjVhrDufkHY2w1TlDeoN0ofvQGARHPiEyF5gnCsjTPXhMtE840dyisn1gQv6Y/s320/7f0925c9cf6f4093678c62616dc12746-33.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhwkVmv1oTn5c7azQQx8rPlN4I3keDzrsFLCZY23YKTmueoRFF6t-gFk0QxBBzs-Idqt2xV5F6pTuwMvjoOKlBy5PgAnvCxzfreTFEXnI6t27t3jxEMo1mMtBlim2pnyVoTLpMvtOkwDrcpIfZr7EqVQpecHh47zNFuV5_QJAnRtV0IRKnBYv1Q-hW4PWo/s320/7f0925c9cf6f4093678c62616dc12746-34.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmAabOxzZB4pHGiJrXYTTQ2pi-5lJKI1UDxVfrwFzqU6wIMUBnhlXVQVduopKJ2ieFLO-JIW5mwvsPR7Q7WQ-t5-DFJXTa1jGvvNZ_HLoPoNeP0EZsBpD4cLJIQjIAH3LAQdxq8NlPnGKzJLRbTvkVbN669cv4gUjrTTBvU2ZDTlS9ukYGvVsR7YnjnlU/s320/7f0925c9cf6f4093678c62616dc12746-35.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiCTIGopKfYEipJBYXT2C2sSYoPe6CtEur1K9XVWtbGt1467QduLkwuNlTAPjAcYX5kt7y-1nb0-lCFoiX9e-HwS73HlpjcbdWY0cK8VusjIglCHEQG_Zg88C5iTWuXP4oVgEXuoTFQ4lHW2o8y0b8yXZ5_No3ntqGJHwZ1K4Knvx6MiAAvo1xCV_bfKz8/s320/7f0925c9cf6f4093678c62616dc12746-36.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhAsEmtQHkpucoeLXoaRm0cW9wO3cRKUaSNNiavRMFVhbkVaQagNQS3QPZj7bhuyLfTOz8lsqMnCCk274LtOgE359qR3tU4L07g-0-dHMjzD09PCgRDwxc9ugYJwTvg3XD2V07ECEHjjfKYiU1rhG_OJpWC88mDxIoj8wxcl2oVpjKAFZNRxDHN0vNIQ-o/s320/7f0925c9cf6f4093678c62616dc12746-37.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgSqisF7mXbfh76QeQSkDuF6hq0dvkvSNWXtwQHvEy7ZLS1f693c6iY28qa95ny9suduiFitxj0b23qVNDlaY7RS6Nt5x-BZ8Ag-5L6iAXLtCOpK4lxvRG8yldZ9mQgSqO0ymyQwEPQxVlwt0McC88E6GhH3mV7qqSjDrZfAaYj2vLPxs9ZTXKSSqFwKso/s320/7f0925c9cf6f4093678c62616dc12746-38.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgGAJBMo9M9HReTwfiVF8PIwMuU4lggPNCdL8DpVjiB5nUzCIL1kqxgJRoQRYPmiOa8q2PAtrABGhO5JwAeJ_9Jixx-q72iNncmlQhQvT10IXM7B9Vry-NiJ0Agib_V65_b5Qu1H7InEYoF10_YrLjsHW1EI3uoka66Mrlgf2x-rPraWEANbujPxGveypw/s320/7f0925c9cf6f4093678c62616dc12746-39.JPG",
        "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjdHA6sf6mdZNInoBpnAH3g8byAGs-cZK8B2ujd3suG3_fsi8Vm3AUjv7bxFspwL0cZ1g77z8IUUo3JY5y9AlHqoO4KK4Bke2KnCNb08d1mBTJyxs-OHUA2MsvW1w8SzOcOG1ZZPh5EDaAauQprk7ZRIz6Xksa-MFgbctz2VPfse3hb2G5-XUm-KQoLrC4/s320/7f0925c9cf6f4093678c62616dc12746-40.JPG"
    ];

    /**
     * Abre el selector de archivos (cámara o galería).
     */
    function abrirCamara() {
        document.getElementById('file-montero').click();
    }

    /**
     * Abre el manual utilizando el visor PDF.js en una nueva pestaña.
     */
    function abrirManual() {
        window.open(PDF_VIEWER_URL, '_blank');
        console.log("Intentando abrir manual en: " + PDF_VIEWER_URL);
    }

    /**
     * Procesa la foto cargada por el usuario, la añade al array y actualiza la vista.
     * @param {Event} event - Evento del input file.
     */
    function procesarFotoCargada(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const fotoId = 'user_foto_' + Date.now(); // Prefijo para diferenciar de las precargadas
            fotosCargadas.push({
                id: fotoId,
                src: e.target.result, // Base64 data URL
                name: file.name,
                details: '' 
            });
            renderizarFotosPrincipales();
            console.log('Foto de usuario añadida:', file.name, fotoId);
        }
        reader.readAsDataURL(file);
        event.target.value = null; 
    }

    /**
     * Renderiza las fotos en la vista principal (#fotos-montero-display).
     * Incluye los detalles visibles debajo de cada imagen.
     */
    function renderizarFotosPrincipales() {
        const displayDiv = document.getElementById('fotos-montero-display');
        displayDiv.innerHTML = ''; 

        fotosCargadas.forEach(foto => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('photo-display-item');
            
            const img = document.createElement('img');
            img.src = foto.src;
            img.alt = 'Foto: ' + foto.name;
            img.onclick = () => abrirImagenFullscreen(foto.src, foto.details); 
            
            // Añadir un manejador de error para las imágenes externas
            if (foto.src.startsWith('http')) {
                img.onerror = function() {
                    this.alt = 'Error al cargar: ' + foto.name;
                    this.src = 'https://placehold.co/100x100/FF0000/FFFFFF?text=Error'; // Imagen de placeholder en caso de error
                    console.warn('No se pudo cargar la imagen externa: ' + foto.src);
                };
            }
            
            if (foto.details && foto.details.trim() !== '') {
                img.title = foto.details; 
            }
            
            itemDiv.appendChild(img);

            if (foto.details && foto.details.trim() !== '') {
                const detailsP = document.createElement('p');
                detailsP.classList.add('photo-display-item-details');
                detailsP.textContent = foto.details;
                itemDiv.appendChild(detailsP);
            } else {
                const emptyDetailsP = document.createElement('p');
                emptyDetailsP.classList.add('photo-display-item-details');
                emptyDetailsP.innerHTML = '&nbsp;'; 
                itemDiv.appendChild(emptyDetailsP);
            }
            
            displayDiv.appendChild(itemDiv);
        });
    }

    /**
     * Abre el modal de configuración de fotos y lo puebla.
     */
    function abrirModalConfiguracionFotos() {
        const galleryDiv = document.getElementById('config-fotos-gallery');
        galleryDiv.innerHTML = ''; 

        if (fotosCargadas.length === 0) {
            galleryDiv.innerHTML = '<p>No hay fotos cargadas para configurar.</p>';
        } else {
            fotosCargadas.forEach(foto => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('config-photo-item');

                const img = document.createElement('img');
                img.src = foto.src;
                img.alt = foto.name;
                 if (foto.src.startsWith('http')) {
                    img.onerror = function() { this.alt = 'Error'; this.src = 'https://placehold.co/70x70/FF0000/FFFFFF?text=Error';};
                }


                const detailsTextarea = document.createElement('textarea');
                detailsTextarea.placeholder = 'Detalles de la foto...';
                detailsTextarea.value = foto.details;
                detailsTextarea.oninput = function() {
                    const fotoIndex = fotosCargadas.findIndex(f => f.id === foto.id);
                    if (fotoIndex !== -1) {
                        fotosCargadas[fotoIndex].details = this.value;
                        renderizarFotosPrincipales(); 
                    }
                };
                
                const checkboxContainer = document.createElement('div');
                checkboxContainer.classList.add('checkbox-container');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = foto.id;
                checkbox.id = 'chk_' + foto.id;
                
                const label = document.createElement('label');
                label.htmlFor = 'chk_' + foto.id;
                label.textContent = " Marcar para borrar";

                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);

                itemDiv.appendChild(img);
                itemDiv.appendChild(detailsTextarea); 
                itemDiv.appendChild(checkboxContainer);
                galleryDiv.appendChild(itemDiv);
            });
        }
        document.getElementById('pin-input').value = ''; 
        document.getElementById('config-fotos-modal').style.display = 'flex'; // Mostrar modal de config
    }

    /**
     * Cierra el modal de configuración de fotos.
     */
    function cerrarModalConfiguracionFotos() {
        document.getElementById('config-fotos-modal').style.display = 'none';
        renderizarFotosPrincipales(); 
    }

    /**
     * Solicita el PIN y procesa el borrado de fotos seleccionadas.
     */
    function solicitarBorradoFotos() {
        const pinIngresado = document.getElementById('pin-input').value;
        const PIN_CORRECTO = '8384';

        if (pinIngresado !== PIN_CORRECTO) {
            alert('PIN incorrecto. No se pueden eliminar las fotos.');
            document.getElementById('pin-input').focus();
            return;
        }

        const checkboxes = document.querySelectorAll('#config-fotos-gallery input[type="checkbox"]:checked');
        const idsParaBorrar = Array.from(checkboxes).map(cb => cb.value);

        if (idsParaBorrar.length === 0) {
            alert('No has seleccionado ninguna foto para eliminar.');
            return;
        }

        fotosCargadas = fotosCargadas.filter(foto => !idsParaBorrar.includes(foto.id));
        
        renderizarFotosPrincipales(); 
        cerrarModalConfiguracionFotos(); 
        alert(idsParaBorrar.length + ' foto(s) eliminada(s) correctamente.');
    }

    /**
     * Abre el modal de imagen a pantalla completa.
     * @param {string} imageSrc - La URL de la imagen a mostrar.
     * @param {string} imageDetails - Los detalles de la imagen.
     */
    function abrirImagenFullscreen(imageSrc, imageDetails) {
        const fullscreenModal = document.getElementById('fullscreen-image-modal');
        const fullscreenImage = document.getElementById('fullscreen-image');
        fullscreenImage.src = imageSrc;
        
        if (imageSrc.startsWith('http')) {
            fullscreenImage.onerror = function() {
                this.alt = 'Error al cargar imagen en pantalla completa';
                this.src = 'https://placehold.co/600x400/FF0000/FFFFFF?text=Error+al+cargar+imagen';
                console.warn('No se pudo cargar la imagen externa en pantalla completa: ' + imageSrc);
            };
        } else {
             fullscreenImage.onerror = null; 
        }

        const detailsDiv = document.getElementById('fullscreen-details');
        if (imageDetails && imageDetails.trim() !== '') {
            detailsDiv.textContent = imageDetails;
            detailsDiv.style.display = 'block';
        } else {
            detailsDiv.textContent = '';
            detailsDiv.style.display = 'none';
        }
        fullscreenModal.style.display = 'flex'; // Asegurar que se muestre con flex para centrar
    }

    /**
     * Cierra el modal de imagen a pantalla completa.
     */
    function cerrarImagenFullscreen(event, forceClose = false) {
        const modal = document.getElementById('fullscreen-image-modal');
        // Cerrar si se hace clic en el fondo del modal (fuera de .fullscreen-modal-content), 
        // en el botón X, o en la propia imagen (que está dentro de .fullscreen-modal-content)
        if (forceClose || (event && (event.target === modal || event.target.id === 'fullscreen-image'))) { 
            modal.style.display = 'none';
            document.getElementById('fullscreen-image').src = ''; 
            document.getElementById('fullscreen-details').textContent = '';
        }
    }
    
    /**
     * Guarda las notas generales.
     */
    function guardarNotasGenerales() {
        const notasTextarea = document.getElementById('notas-montero');
        if (notasTextarea) {
            const notas = notasTextarea.value;
            localStorage.setItem('notas_generales_montero', notas); 
            
            const botonGuardar = notasTextarea.nextElementSibling; 
            const mensajeOriginalBoton = botonGuardar.textContent;
            botonGuardar.textContent = '¡Guardado!';
            setTimeout(() => {
                botonGuardar.textContent = mensajeOriginalBoton;
            }, 2000); 
        }
    }

    /**
     * Carga inicial de datos.
     */
    window.onload = function() {
        // Precargar imágenes del manual desde URLs externas
        manualImageUrls.forEach((url, index) => {
            fotosCargadas.push({
                id: 'manual_foto_' + (index + 1),
                src: url,
                name: 'Página Manual ' + (index + 1),
                details: 'Página ' + (index + 1) + ' del manual de servicio.' 
            });
        });

        const notasGeneralesGuardadas = localStorage.getItem('notas_generales_montero');
        const notasTextarea = document.getElementById('notas-montero');
        if (notasGeneralesGuardadas && notasTextarea) {
            notasTextarea.value = notasGeneralesGuardadas;
        }
        renderizarFotosPrincipales(); 

        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (document.getElementById('config-fotos-modal').style.display === 'flex') { // Cambiado a flex
                    cerrarModalConfiguracionFotos();
                }
                if (document.getElementById('fullscreen-image-modal').style.display === 'flex') {
                    cerrarImagenFullscreen(null, true);
                }
            }
        });
    };
</script>

</body>
</html>
